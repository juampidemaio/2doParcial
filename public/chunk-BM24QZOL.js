import{a as ce}from"./chunk-KNHPH4NO.js";import{a as J,b as g,c as K,d as X,e as Z,f as ee,g as te,h as ie,i as oe,j as re,k as ne,m as ae,n as ve,o as se}from"./chunk-U6OKUOUY.js";import{A as S,E as d,G as l,I as a,J as n,K as T,M as q,O as c,P as $,a as f,b as U,d as fe,e as p,ea as V,fa as z,ga as B,h as W,ja as F,l as b,la as G,m as _,o as v,p as Y,q as D,qa as P,sa as h,ta as y,ua as L,va as x,xa as M,ya as Q,z as m,za as E}from"./chunk-6FCPAOD2.js";var I=fe(ve());var N=class i{constructor(e){this.firestore=e}getEspecialistasPorEspecialidad(e){return p(this,null,function*(){let t=h(this.firestore,"users");return(yield x(t)).docs.map(r=>f({id:r.id},r.data())).filter(r=>this.especialistaValido(r,e))})}especialistaValido(e,t){return e.rol==="especialista"&&e.especialidades.includes(t)}getHorariosPorEspecialista(e){return p(this,null,function*(){let t=h(this.firestore,"horarios"),o=yield x(t),r=yield this.getTurnosPorEspecialista(e);return o.docs.map(s=>{let u=s.data();return f({id:s.id},u)}).filter(s=>s.especialistaId===e&&this.isWithinNext15Days(s.fecha)&&!this.isHorarioOcupado(s,r))})}getTurnosPorEspecialista(e){return p(this,null,function*(){let t=h(this.firestore,"turnos");return(yield x(t)).docs.map(r=>{let s=r.data();return f({id:r.id},s)}).filter(r=>r.especialistaId===e)})}isHorarioOcupado(e,t){let o=new Date(e.fecha),r=new Date(o);return r.setMinutes(r.getMinutes()+30),t.some(s=>{let u=new Date(s.fecha),C=new Date(u);return C.setMinutes(C.getMinutes()+30),u<r&&C>o})}isWithinNext15Days(e){let t=new Date(e),o=new Date,r=new Date;return r.setDate(o.getDate()+15),t>=o&&t<=r}solicitarTurno(e){return p(this,null,function*(){let t=y(h(this.firestore,"turnos"));yield M(t,e)})}static \u0275fac=function(t){return new(t||i)(v(P))};static \u0275prov=b({token:i,factory:i.\u0275fac,providedIn:"root"})};var Se=Math.pow(10,8)*24*60*60*1e3,ke=-Se;var be=3600;var pe=be*24,qe=pe*7,ye=pe*365.2425,xe=ye/12,$e=xe*3,H=Symbol.for("constructDateFrom");function le(i,e){return typeof i=="function"?i(e):i&&typeof i=="object"&&H in i?i[H](e):i instanceof Date?new i.constructor(e):new Date(e)}function A(i,e){return le(e||i,i)}function me(i,e,t){let o=+A(i,t?.in),[r,s]=[+A(e.start,t?.in),+A(e.end,t?.in)].sort((u,C)=>u-C);return o>=r&&o<=s}var O=class i{constructor(e,t){this.firestore=e;this.authService=t}horariosApertura={lunes:{apertura:"08:00",cierre:"19:00"},martes:{apertura:"08:00",cierre:"19:00"},mi\u00E9rcoles:{apertura:"08:00",cierre:"19:00"},jueves:{apertura:"08:00",cierre:"19:00"},viernes:{apertura:"08:00",cierre:"19:00"},s\u00E1bado:{apertura:"08:00",cierre:"14:00"},domingo:{apertura:null,cierre:null}};estaAbierto(e,t){let o=this.horariosApertura[e];if(!o||!o.apertura||!o.cierre)return!1;let r=new Date(`1970-01-01T${t}:00`),s=new Date(`1970-01-01T${o.apertura}:00`),u=new Date(`1970-01-01T${o.cierre}:00`);return me(r,{start:s,end:u})}solicitarTurno(e){return p(this,null,function*(){let t=yield this.authService.getUser().toPromise();if(t){let{dia:o,hora:r}=e;if(!this.estaAbierto(o,r))throw new Error("La cl\xEDnica est\xE1 cerrada en el horario solicitado. Por favor, elija otro horario.");let s=U(f({},e),{pacienteId:t.uid,pacienteNombre:t.nombre}),u=y(h(this.firestore,"turnos"));yield M(u,s)}else throw new Error("No hay usuario autenticado")})}getTurnos(){return p(this,null,function*(){let e=h(this.firestore,"turnos");return(yield x(e)).docs.map(o=>f({id:o.id},o.data()))})}getTurno(e){return p(this,null,function*(){let t=y(this.firestore,`turnos/${e}`),o=yield L(t);if(o.exists())return f({id:o.id},o.data());throw new Error("No se encontr\xF3 el turno")})}updateTurno(e,t){return p(this,null,function*(){let o=y(this.firestore,`turnos/${e}`);yield Q(o,t)})}static \u0275fac=function(t){return new(t||i)(v(P),v(E))};static \u0275prov=b({token:i,factory:i.\u0275fac,providedIn:"root"})};function Ce(i,e){if(i&1&&(a(0,"option",17),c(1),n()),i&2){let t=e.$implicit;l("value",t.nombre),m(),$(t.nombre)}}function Te(i,e){i&1&&(a(0,"div"),c(1,"Este campo es obligatorio."),n())}function we(i,e){if(i&1&&(a(0,"option",17),c(1),n()),i&2){let t=e.$implicit;l("value",t.id),m(),$(t.nombre)}}function _e(i,e){i&1&&(a(0,"div"),c(1,"Este campo es obligatorio."),n())}function De(i,e){i&1&&(a(0,"div"),c(1,"Este campo es obligatorio."),n())}function Fe(i,e){i&1&&(a(0,"div"),c(1,"Este campo es obligatorio."),n())}function Pe(i,e){i&1&&(a(0,"div"),c(1,"Este campo es obligatorio."),n())}function Me(i,e){i&1&&(a(0,"div"),c(1,"El DNI debe tener 8 d\xEDgitos."),n())}function Ne(i,e){i&1&&(a(0,"div"),c(1,"Este campo es obligatorio."),n())}var j=class i{constructor(e,t,o,r,s,u){this.especialidadService=e;this.especialistaService=t;this.turnoService=o;this.authService=r;this.fb=s;this.router=u;this.turnoForm=this.fb.group({especialidad:["",g.required],especialista:["",g.required],horario:["",g.required],paciente:["",g.required],dni:["",[g.required,g.pattern(/^[0-9]{8}$/)]],obraSocial:["",g.required]})}especialidades=[];especialistas=[];horarios=[];turnoForm;isAdmin=!1;isPaciente=!1;ngOnInit(){this.cargarEspecialidades(),this.checkUserRole()}cargarEspecialidades(){return p(this,null,function*(){try{this.especialidades=yield this.especialidadService.getEspecialidades()}catch{I.default.fire("Error","No se pudieron cargar las especialidades","error")}})}checkUserRole(){return p(this,null,function*(){this.authService.getUser().subscribe(e=>{e&&(this.isAdmin=e.role==="administrador",this.isPaciente=e.role==="paciente")})})}onEspecialidadChange(e){let t=e.target.value;t&&this.cargarEspecialistas(t)}cargarEspecialistas(e){return p(this,null,function*(){try{this.especialistas=yield this.especialistaService.getEspecialistasPorEspecialidad(e)}catch{I.default.fire("Error","No se pudieron cargar los especialistas","error")}})}solicitarTurno(){return p(this,null,function*(){if(this.turnoForm.valid)try{let e=this.turnoForm.value;yield this.turnoService.solicitarTurno(e),I.default.fire("\xC9xito","Turno solicitado correctamente","success"),this.router.navigate(["/turnos"])}catch{I.default.fire("Error","No se pudo solicitar el turno","error")}else I.default.fire("Formulario inv\xE1lido","Por favor, completa todos los campos correctamente.","warning")})}mostrarError(e,t){let o=this.turnoForm.get(e);return o?o.hasError(t)&&(o.dirty||o.touched):!1}static \u0275fac=function(t){return new(t||i)(S(se),S(N),S(O),S(E),S(ne),S(F))};static \u0275cmp=Y({type:i,selectors:[["app-solicitar-turno"]],decls:40,vars:10,consts:[[3,"ngSubmit","formGroup"],["for","especialidad"],["id","especialidad","formControlName","especialidad",3,"change"],["value",""],[3,"value",4,"ngFor","ngForOf"],[4,"ngIf"],["for","especialista"],["id","especialista","formControlName","especialista"],["for","horario"],["id","horario","type","datetime-local","formControlName","horario"],["for","paciente"],["id","paciente","formControlName","paciente"],["for","dni"],["id","dni","formControlName","dni"],["for","obraSocial"],["id","obraSocial","formControlName","obraSocial"],["type","submit"],[3,"value"]],template:function(t,o){t&1&&(a(0,"form",0),q("ngSubmit",function(){return o.solicitarTurno()}),a(1,"div")(2,"label",1),c(3,"Especialidad:"),n(),a(4,"select",2),q("change",function(s){return o.onEspecialidadChange(s)}),a(5,"option",3),c(6,"Seleccione una especialidad"),n(),d(7,Ce,2,2,"option",4),n(),d(8,Te,2,0,"div",5),n(),a(9,"div")(10,"label",6),c(11,"Especialista:"),n(),a(12,"select",7)(13,"option",3),c(14,"Seleccione un especialista"),n(),d(15,we,2,2,"option",4),n(),d(16,_e,2,0,"div",5),n(),a(17,"div")(18,"label",8),c(19,"Horario:"),n(),T(20,"input",9),d(21,De,2,0,"div",5),n(),a(22,"div")(23,"label",10),c(24,"Paciente:"),n(),T(25,"input",11),d(26,Fe,2,0,"div",5),n(),a(27,"div")(28,"label",12),c(29,"DNI:"),n(),T(30,"input",13),d(31,Pe,2,0,"div",5)(32,Me,2,0,"div",5),n(),a(33,"div")(34,"label",14),c(35,"Obra Social:"),n(),T(36,"input",15),d(37,Ne,2,0,"div",5),n(),a(38,"button",16),c(39,"Solicitar Turno"),n()()),t&2&&(l("formGroup",o.turnoForm),m(7),l("ngForOf",o.especialidades),m(),l("ngIf",o.mostrarError("especialidad","required")),m(7),l("ngForOf",o.especialistas),m(),l("ngIf",o.mostrarError("especialista","required")),m(5),l("ngIf",o.mostrarError("horario","required")),m(5),l("ngIf",o.mostrarError("paciente","required")),m(5),l("ngIf",o.mostrarError("dni","required")),m(),l("ngIf",o.mostrarError("dni","pattern")),m(5),l("ngIf",o.mostrarError("obraSocial","required")))},dependencies:[V,z,Z,oe,re,J,ie,K,X,ee,te],styles:['@charset "UTF-8";form[_ngcontent-%COMP%]{max-width:800px;margin:20px auto;padding:30px;border:2px solid #007bff;border-radius:15px;background-color:#e0f7fa;box-shadow:0 4px 20px #0003}label[_ngcontent-%COMP%]{font-weight:700;margin-bottom:5px;display:block;color:#007bff}input[type=text][_ngcontent-%COMP%], select[_ngcontent-%COMP%]{width:100%;padding:12px;border:1px solid #007bff;border-radius:6px;font-size:16px;margin-bottom:15px;box-sizing:border-box;transition:border-color .3s,background-color .3s;background-color:#f1f1f1}input[type=text][_ngcontent-%COMP%]:focus, select[_ngcontent-%COMP%]:focus{border-color:#0056b3;outline:none;background-color:#fff}div[ngIf][_ngcontent-%COMP%]{color:#dc3545;font-size:.9em;margin-top:-10px;margin-bottom:10px}button[type=submit][_ngcontent-%COMP%]{background-color:#007bff;color:#fff;padding:12px 15px;border:none;border-radius:6px;cursor:pointer;transition:background-color .3s,transform .2s;width:100%;font-size:1em}button[type=submit][_ngcontent-%COMP%]:hover{background-color:#0056b3;transform:translateY(-2px)}div[_ngcontent-%COMP%]{margin-bottom:20px}div[_ngcontent-%COMP%]   *[_ngcontent-%COMP%]   ngIf[_ngcontent-%COMP%]{margin-bottom:20px}']})};var R=class i{constructor(e,t){this.authService=e;this.router=t}canActivate(e,t){return this.authService.getUser().pipe(W(o=>o&&(o.role==="administrador"||o.role==="paciente")?!0:(this.router.navigate(["/bienvenida"]),console.log("Acceso denegado: no es administrador ni paciente"),!1)))}static \u0275fac=function(t){return new(t||i)(v(E),v(F))};static \u0275prov=b({token:i,factory:i.\u0275fac,providedIn:"root"})};var Ae=[{path:"solicitar-turno",component:j,canActivate:[R]}],k=class i{static \u0275fac=function(t){return new(t||i)};static \u0275mod=D({type:i});static \u0275inj=_({imports:[G.forChild(Ae),G]})};var de=class i{static \u0275fac=function(t){return new(t||i)};static \u0275mod=D({type:i});static \u0275inj=_({imports:[B,k,ae,ce]})};export{de as SeccionTurnosModule};
