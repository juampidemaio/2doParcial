import{a as ue,b as de}from"./chunk-S6K4CJ5X.js";import{a as ee,b as te,c as ie,d as oe,e as re,f as ne,g as ae,h as se,i as ce,j as pe,l as le,m as Ie,n as me}from"./chunk-ZKRPGI45.js";import{A as S,Aa as I,E as x,G as p,I as s,J as c,K as D,L as B,M as E,N as q,O as u,P as k,R as Q,a as d,b as G,d as ge,e as a,fa as z,ga as J,h as W,ha as K,ka as F,l as v,m as w,ma as H,o as f,p as U,q as C,ra as _,t as Y,ta as h,u as L,ua as y,va as X,wa as g,ya as A,z as m,za as Z}from"./chunk-VE5QODOT.js";var $=ge(Ie());var N=class o{constructor(e){this.firestore=e}getEspecialistasPorEspecialidad(e){return a(this,null,function*(){let t=h(this.firestore,"users");return(yield g(t)).docs.map(r=>d({id:r.id},r.data())).filter(r=>this.especialistaValido(r,e))})}especialistaValido(e,t){return e.rol==="especialista"&&e.especialidadId===t}getHorariosPorEspecialista(e){return a(this,null,function*(){let t=h(this.firestore,"horarios"),i=yield g(t),r=yield this.getTurnosPorEspecialista(e);return i.docs.map(n=>{let l=n.data();return d({id:n.id},l)}).filter(n=>n.especialistaId===e&&this.isWithinNext15Days(n.fecha)&&!this.isHorarioOcupado(n,r))})}getTurnosPorEspecialista(e){return a(this,null,function*(){let t=h(this.firestore,"turnos");return(yield g(t)).docs.map(r=>{let n=r.data();return d({id:r.id},n)}).filter(r=>r.especialistaId===e)})}isHorarioOcupado(e,t){let i=new Date(e.fecha),r=new Date(i);return r.setMinutes(r.getMinutes()+30),t.some(n=>{let l=new Date(n.fecha),b=new Date(l);return b.setMinutes(b.getMinutes()+30),l<r&&b>i})}isWithinNext15Days(e){let t=new Date(e),i=new Date,r=new Date;return r.setDate(i.getDate()+15),t>=i&&t<=r}solicitarTurno(e){return a(this,null,function*(){let t=y(h(this.firestore,"turnos"));yield A(t,e)})}static \u0275fac=function(t){return new(t||o)(f(_))};static \u0275prov=v({token:o,factory:o.\u0275fac,providedIn:"root"})};var Ee=Math.pow(10,8)*24*60*60*1e3,ke=-Ee;var Te=3600;var fe=Te*24,He=fe*7,we=fe*365.2425,Ce=we/12,Ve=Ce*3,V=Symbol.for("constructDateFrom");function he(o,e){return typeof o=="function"?o(e):o&&typeof o=="object"&&V in o?o[V](e):o instanceof Date?new o.constructor(e):new Date(e)}function P(o,e){return he(e||o,o)}function Se(o,e,t){let i=+P(o,t?.in),[r,n]=[+P(e.start,t?.in),+P(e.end,t?.in)].sort((l,b)=>l-b);return i>=r&&i<=n}var j=class o{constructor(e,t){this.firestore=e;this.authService=t}horariosApertura={lunes:{apertura:"08:00",cierre:"19:00"},martes:{apertura:"08:00",cierre:"19:00"},mi\u00E9rcoles:{apertura:"08:00",cierre:"19:00"},jueves:{apertura:"08:00",cierre:"19:00"},viernes:{apertura:"08:00",cierre:"19:00"},s\u00E1bado:{apertura:"08:00",cierre:"14:00"},domingo:{apertura:null,cierre:null}};estaAbierto(e,t){let i=this.horariosApertura[e];if(!i||!i.apertura||!i.cierre)return!1;let r=new Date(`1970-01-01T${t}:00`),n=new Date(`1970-01-01T${i.apertura}:00`),l=new Date(`1970-01-01T${i.cierre}:00`);return Se(r,{start:n,end:l})}solicitarTurno(e){return a(this,null,function*(){let t=yield this.authService.getUser().toPromise();if(t){let{dia:i,hora:r}=e;if(!this.estaAbierto(i,r))throw new Error("La cl\xEDnica est\xE1 cerrada en el horario solicitado. Por favor, elija otro horario.");let n=G(d({},e),{pacienteId:t.uid,pacienteNombre:t.nombre}),l=y(h(this.firestore,"turnos"));yield A(l,n)}else throw new Error("No hay usuario autenticado")})}getTurnos(){return a(this,null,function*(){let e=h(this.firestore,"turnos");return(yield g(e)).docs.map(i=>d({id:i.id},i.data()))})}getTurno(e){return a(this,null,function*(){let t=y(this.firestore,`turnos/${e}`),i=yield X(t);if(i.exists())return d({id:i.id},i.data());throw new Error("No se encontr\xF3 el turno")})}updateTurno(e,t){return a(this,null,function*(){let i=y(this.firestore,`turnos/${e}`);yield Z(i,t)})}static \u0275fac=function(t){return new(t||o)(f(_),f(I))};static \u0275prov=v({token:o,factory:o.\u0275fac,providedIn:"root"})};function _e(o,e){if(o&1&&(s(0,"option",16),u(1),c()),o&2){let t=e.$implicit;p("value",t.id),m(),k(t.nombre)}}function Ae(o,e){if(o&1&&(s(0,"option",16),u(1),c()),o&2){let t=e.$implicit;p("value",t.id),m(),k(t.nombre)}}function Ne(o,e){if(o&1&&(s(0,"option",16),u(1),c()),o&2){let t=e.$implicit;p("value",t.id),m(),Q("",t.fecha," - ",t.hora,"")}}function Pe(o,e){if(o&1){let t=B();s(0,"app-listado-paciente",17),E("usuarioSeleccionado",function(r){Y(t);let n=q();return L(n.setPacienteData(r))}),c()}}var M=class o{constructor(e,t,i,r,n,l){this.especialidadService=e;this.especialistaService=t;this.turnoService=i;this.authService=r;this.fb=n;this.router=l;this.turnoForm=this.fb.group({especialidad:[""],especialista:[""],horario:[""],paciente:[""],dni:[""],obraSocial:[""]})}especialidades=[];especialistas=[];horarios=[];turnoForm;isAdmin=!1;isPaciente=!1;usuarioSeleccionado;ngOnInit(){this.cargarEspecialidades(),this.checkUserRole()}cargarEspecialidades(){return a(this,null,function*(){this.especialidades=yield this.especialidadService.getEspecialidades()})}checkUserRole(){return a(this,null,function*(){this.authService.getUser().subscribe(e=>{e&&(this.isAdmin=e.role==="administrador",this.isPaciente=e.role==="paciente")})})}setPacienteData(e){return a(this,null,function*(){this.usuarioSeleccionado=e,e&&this.turnoForm.patchValue({paciente:e.nombre,dni:e.dni,obraSocial:e.obraSocial})})}onEspecialidadChange(e){return a(this,null,function*(){let i=e.target.value;this.especialistas=yield this.especialistaService.getEspecialistasPorEspecialidad(i)})}onEspecialistaChange(e){return a(this,null,function*(){let i=e.target.value;this.horarios=yield this.especialistaService.getHorariosPorEspecialista(i)})}solicitarTurno(){return a(this,null,function*(){let e=this.turnoForm.value;try{yield this.turnoService.solicitarTurno(e),$.default.fire("Registro exitoso","El turno ha sido solicitado correctamente","success"),this.router.navigate(["/bienvenida"])}catch{$.default.fire("Error","No se pudo solicitar el turno. Int\xE9ntalo nuevamente.","error")}})}static \u0275fac=function(t){return new(t||o)(S(me),S(N),S(j),S(I),S(pe),S(F))};static \u0275cmp=U({type:o,selectors:[["app-solicitar-turno"]],decls:25,vars:8,consts:[[3,"ngSubmit","formGroup"],["for","especialidad"],["id","especialidad","formControlName","especialidad",3,"change"],[3,"value",4,"ngFor","ngForOf"],["for","especialista"],["id","especialista","formControlName","especialista",3,"change"],["for","horario"],["id","horario","formControlName","horario"],["for","paciente"],["id","paciente","formControlName","paciente","type","text",3,"readonly"],["for","dni"],["id","dni","formControlName","dni","type","text",3,"readonly"],["for","obraSocial"],["id","obraSocial","formControlName","obraSocial","type","text",3,"readonly"],[3,"usuarioSeleccionado",4,"ngIf"],["type","submit"],[3,"value"],[3,"usuarioSeleccionado"]],template:function(t,i){t&1&&(s(0,"form",0),E("ngSubmit",function(){return i.solicitarTurno()}),s(1,"label",1),u(2,"Especialidad:"),c(),s(3,"select",2),E("change",function(n){return i.onEspecialidadChange(n)}),x(4,_e,2,2,"option",3),c(),s(5,"label",4),u(6,"Especialista:"),c(),s(7,"select",5),E("change",function(n){return i.onEspecialistaChange(n)}),x(8,Ae,2,2,"option",3),c(),s(9,"label",6),u(10,"Horario:"),c(),s(11,"select",7),x(12,Ne,2,3,"option",3),c(),s(13,"label",8),u(14,"Paciente:"),c(),D(15,"input",9),s(16,"label",10),u(17,"DNI:"),c(),D(18,"input",11),s(19,"label",12),u(20,"Obra Social:"),c(),D(21,"input",13),x(22,Pe,1,0,"app-listado-paciente",14),s(23,"button",15),u(24,"Solicitar Turno"),c()()),t&2&&(p("formGroup",i.turnoForm),m(4),p("ngForOf",i.especialidades),m(4),p("ngForOf",i.especialistas),m(4),p("ngForOf",i.horarios),m(3),p("readonly",i.isAdmin),m(3),p("readonly",i.isAdmin),m(3),p("readonly",i.isAdmin),m(),p("ngIf",i.isAdmin))},dependencies:[z,J,oe,se,ce,ee,ae,te,ie,re,ne,ue]})};var R=class o{constructor(e,t){this.authService=e;this.router=t}canActivate(e,t){return this.authService.getUser().pipe(W(i=>i&&(i.role==="administrador"||i.role==="paciente")?!0:(this.router.navigate(["/home"]),console.log("Acceso denegado: no es administrador ni paciente"),!1)))}static \u0275fac=function(t){return new(t||o)(f(I),f(F))};static \u0275prov=v({token:o,factory:o.\u0275fac,providedIn:"root"})};var je=[{path:"solicitar-turno",component:M,canActivate:[R]}],O=class o{static \u0275fac=function(t){return new(t||o)};static \u0275mod=C({type:o});static \u0275inj=w({imports:[H.forChild(je),H]})};var ye=class o{static \u0275fac=function(t){return new(t||o)};static \u0275mod=C({type:o});static \u0275inj=w({imports:[K,O,le,de]})};export{ye as SeccionTurnosModule};
